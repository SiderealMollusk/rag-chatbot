version: '3.8'

services:
  # The Brains: Python/FastAPI
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: movie_bible_api
    volumes:
      - ./backend:/app
      - ./data:/data
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=sqlite:////data/bible.db
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  # The Face: Next.js
  web:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: movie_bible_web
    volumes:
      - ./frontend:/app
      # Don't mount node_modules to avoid host/container mismatch
      - /app/node_modules
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
    depends_on:
      - api

  redis:
    image: redis:alpine
    container_name: movie_bible_redis
    ports:
      - "6379:6379"

  worker_cloud:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: movie_bible_worker_cloud
    volumes:
      - ./backend:/app
      - ./data:/data
    environment:
      - DATABASE_URL=sqlite:////data/bible.db
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    command: celery -A tasks worker -Q queue_cloud -c 10 --loglevel=info
    depends_on:
      - redis
      - api

  worker_metal:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: movie_bible_worker_metal
    volumes:
      - ./backend:/app
      - ./data:/data
    environment:
      - DATABASE_URL=sqlite:////data/bible.db
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - OLLAMA_URL=http://host.docker.internal:11434/api/chat
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: celery -A tasks worker -Q queue_metal -c 1 --loglevel=info
    depends_on:
      - redis
      - api

  flower:
    image: mher/flower
    container_name: movie_bible_flower
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
    ports:
      - "5555:5555"
    depends_on:
      - redis

  shell:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: movie_bible_shell
    volumes:
      - ./backend:/app
      - ./data/shell:/data
      - ./scripts:/scripts
    environment:
      - DATABASE_URL=sqlite:////data/bible.db
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - EXECUTION_CONTEXT=shell
    command: tail -f /dev/null
    depends_on:
      - redis
      - api

  # The Tooling: CLI Runner (Optional, can just run locally)
  cli:
    build:
      context: ./cli
      dockerfile: Dockerfile
    container_name: movie_bible_cli
    volumes:
      - ./cli:/app
      - ./data:/data
    environment:
      - DATABASE_URL=sqlite:////data/bible.db
    command: tail -f /dev/null # Keep alive

  # Log Aggregator
  dozzle:
    container_name: movie_bible_logs
    image: amir20/dozzle
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - 8080:8080
